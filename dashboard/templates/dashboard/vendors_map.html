{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Carte des Vendeurs - Côte d'Ivoire{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-container {
        height: 600px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    #vendorsMap {
        height: 100%;
        width: 100%;
    }
    
    .stats-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #4CAF50, #66BB6A);
        color: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
    }
    
    .stat-card h3 {
        font-size: 2rem;
        font-weight: bold;
        margin: 0;
    }
    
    .stat-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    .region-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .region-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .region-item:last-child {
        border-bottom: none;
    }
    
    .region-name {
        font-weight: 600;
        color: #333;
    }
    
    .region-count {
        background: #4CAF50;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .vendor-popup {
        max-width: 300px;
    }
    
    .vendor-popup h6 {
        color: #4CAF50;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .vendor-popup p {
        margin: 5px 0;
        font-size: 0.9rem;
    }
    
    .vendor-popup .badge {
        background: #4CAF50;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .controls {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .btn-map {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-map:hover {
        background: #45a049;
        transform: translateY(-1px);
    }
    
    .btn-map.active {
        background: #2e7d32;
    }
    
    .legend {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .legend-text {
        font-size: 0.9rem;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-map-marked-alt text-success me-2"></i>
                    Carte des Vendeurs - Côte d'Ivoire
                </h2>
                <div>
                    <a href="{% url 'dashboard:vendors' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-list me-2"></i>Liste des Vendeurs
                    </a>
                    <a href="{% url 'dashboard:create_vendor' %}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Nouveau Vendeur
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Carte -->
            <div class="map-container">
                <div id="vendorsMap"></div>
            </div>
            
            <!-- Contrôles -->
            <div class="controls">
                <h6 class="mb-3">
                    <i class="fas fa-sliders-h me-2"></i>Contrôles de la carte
                </h6>
                <button class="btn-map" onclick="showAllVendors()">
                    <i class="fas fa-eye me-2"></i>Tous les vendeurs
                </button>
                <button class="btn-map" onclick="centerOnAbidjan()">
                    <i class="fas fa-crosshairs me-2"></i>Centrer sur Abidjan
                </button>
                <button class="btn-map" onclick="toggleClustering()">
                    <i class="fas fa-layer-group me-2"></i>Regroupement
                </button>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Statistiques -->
            <div class="stats-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Statistiques
                </h5>
                
                <div class="stat-card">
                    <h3>{{ total_vendors }}</h3>
                    <p>Vendeurs actifs</p>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="stat-card" style="background: linear-gradient(135deg, #2196F3, #42A5F5);">
                            <h3>{{ region_stats|length }}</h3>
                            <p>Régions</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card" style="background: linear-gradient(135deg, #FF9800, #FFB74D);">
                            <h3>{{ city_stats|length }}</h3>
                            <p>Villes</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques par région -->
            <div class="stats-container">
                <h6 class="mb-3">
                    <i class="fas fa-map me-2"></i>Par région
                </h6>
                <div class="region-stats">
                    {% for stat in region_stats %}
                    <div class="region-item">
                        <span class="region-name">{{ stat.region|default:"Non spécifié" }}</span>
                        <span class="region-count">{{ stat.count }}</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">Aucune donnée de région disponible</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Légende -->
            <div class="legend">
                <h6 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>Légende
                </h6>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span class="legend-text">Vendeur actif</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span class="legend-text">Vendeur inactif</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #F44336;"></div>
                    <span class="legend-text">Vendeur suspendu</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
// Données des vendeurs
const vendorsData = {{ vendors_data|safe }};

// Initialiser la carte centrée sur la Côte d'Ivoire
const map = L.map('vendorsMap').setView([7.5400, -5.5471], 7);

// Ajouter la couche de tuiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18
}).addTo(map);

// Groupe de marqueurs pour le clustering
const markers = L.markerClusterGroup({
    chunkedLoading: true,
    maxClusterRadius: 50
});

// Couleurs selon le statut
function getMarkerColor(status) {
    switch(status) {
        case 'active': return '#4CAF50';
        case 'inactive': return '#FF9800';
        case 'suspended': return '#F44336';
        default: return '#9E9E9E';
    }
}

// Icônes personnalisées
function createCustomIcon(status) {
    return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
            background-color: ${getMarkerColor(status)};
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
}

// Ajouter les marqueurs des vendeurs
vendorsData.forEach(vendor => {
    const marker = L.marker([vendor.latitude, vendor.longitude], {
        icon: createCustomIcon(vendor.status)
    });
    
    // Popup avec informations du vendeur
    const popupContent = `
        <div class="vendor-popup">
            <h6>${vendor.name}</h6>
            <p><strong>Adresse:</strong> ${vendor.address}</p>
            <p><strong>Téléphone:</strong> ${vendor.phone}</p>
            <p><strong>Ville:</strong> ${vendor.city || 'Non spécifié'}</p>
            <p><strong>Région:</strong> ${vendor.region || 'Non spécifiée'}</p>
            <p><strong>Statut:</strong> <span class="badge">${vendor.status}</span></p>
            <p><strong>Créé le:</strong> ${vendor.created_at}</p>
        </div>
    `;
    
    marker.bindPopup(popupContent);
    markers.addLayer(marker);
});

// Ajouter le groupe de marqueurs à la carte
map.addLayer(markers);

// Fonctions de contrôle
function showAllVendors() {
    if (vendorsData.length > 0) {
        const group = new L.featureGroup();
        vendorsData.forEach(vendor => {
            group.addLayer(L.marker([vendor.latitude, vendor.longitude]));
        });
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

function centerOnAbidjan() {
    map.setView([5.3600, -4.0083], 12);
}

function toggleClustering() {
    if (map.hasLayer(markers)) {
        map.removeLayer(markers);
        // Ajouter les marqueurs individuellement
        vendorsData.forEach(vendor => {
            const marker = L.marker([vendor.latitude, vendor.longitude], {
                icon: createCustomIcon(vendor.status)
            });
            const popupContent = `
                <div class="vendor-popup">
                    <h6>${vendor.name}</h6>
                    <p><strong>Adresse:</strong> ${vendor.address}</p>
                    <p><strong>Téléphone:</strong> ${vendor.phone}</p>
                    <p><strong>Ville:</strong> ${vendor.city || 'Non spécifié'}</p>
                    <p><strong>Région:</strong> ${vendor.region || 'Non spécifiée'}</p>
                    <p><strong>Statut:</strong> <span class="badge">${vendor.status}</span></p>
                </div>
            `;
            marker.bindPopup(popupContent);
            marker.addTo(map);
        });
    } else {
        map.addLayer(markers);
    }
}

// Ajuster la vue pour montrer tous les vendeurs au chargement
setTimeout(() => {
    if (vendorsData.length > 0) {
        showAllVendors();
    }
}, 1000);
</script>
{% endblock %}
